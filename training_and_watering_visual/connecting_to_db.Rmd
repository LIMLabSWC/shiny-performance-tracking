---
title: "database_drive_access"
author: "Viktor Plattner"
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
---

<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
library(odbc)
library(DBI)
library(ssh)
library(RMariaDB)
library(RMySQL)
library(googlesheets)
library(googledrive)
library(rio)
library(readxl)
library(openxlsx)
library(janitor)
library(formattable)


knitr::opts_chunk$set(echo = TRUE)
```

# connecting to db and drive

## connecting to db
first open an ssh tunnel: ssh -f vplattner@192.168.238.210 -L 8080:172.24.155.100:3306 -N


```{r}

akrami_db <- dbConnect(MySQL(),
  user = "akrami",
  password = "Akrami2019!",
  dbname = "akrami_db",
  host = "localhost",
  port = 8080
)

DBI::dbListTables(akrami_db)
DBI::dbListFields(akrami_db, "sessions")
```

## authenticate drive  

```{r}
drive_auth(
  email = "limlabswc@gmail.com",
  path = NULL,
  scopes = "https://www.googleapis.com/auth/drive.readonly",
  cache = gargle::gargle_oauth_cache(),
  use_oob = TRUE,
  token = NULL
)
```


# Loading and cleaning data



```{r}
# mass <- dplyr::tbl(akrami_db, "mass_log") %>%
#   as_tibble() %>%
#   dplyr::rename(
#     animal_id = animal_ID
#   ) %>%
#   dplyr::select(-col_id)
# mass
```


Tables from database

```{r}
sessions <- dplyr::tbl(
  src = akrami_db,
  sql("SELECT ratname, experimenter, sessiondate, endtime, starttime FROM sessions")
) %>%
  as_tibble() %>%
  dplyr::rename(
    animal_id = ratname,
    date = sessiondate,
    exp_id = experimenter
  ) %>%
  dplyr::mutate(
    date = as.Date(date),
    endtime = as.POSIXct(endtime, format = "%H:%M:%S") %>% format(format = "%H:%M"),
    starttime = as.POSIXct(starttime, format = "%H:%M:%S") %>% format(format = "%H:%M")
  )
sessions
```




```{r}
# water <- dplyr::tbl(akrami_db, "water_log") %>%
#   as_tibble() %>%
#   dplyr::mutate(
#     date = as.Date(date),
#     water_start = as.POSIXct(water_start, format = "%H:%M:%S") %>% format(format = "%H:%M:%S"),
#     water_end = as.POSIXct(water_end, format = "%H:%M:%S") %>% format(format = "%H:%M:%S")) %>%
#   dplyr::select(-ad_lib_start,-ad_lib_end, -col_id)
# water
```


Files on drive

```{r}
drive_find(n_max = 30)
```

```{r}
drive_download(
  file = "Water Log",
  path = file.path("Water Log.xlsx"),
  overwrite = T
)

drive_download(
  file = "Mass Log",
  path = file.path("Mass Log.xlsx"),
  overwrite = T
)

# rio::convert(
#   in_file = file.path("Water Log.xlsx"),
#   out_file = file.path("Water Log.csv"))
```


Convert to csv first. xlsx files are not read correctly (problem with mixed date and time format and conversion)

```{r}
# water <- openxlsx::read.xlsx(file.path("Water Log.xlsx")) %>% as_tibble()
water <- read.csv(file.path("Water Log.csv")) %>%
  as_tibble()

water <- water %>%
  dplyr::mutate(
    date = as.Date(date, tryFormats = c("%d/%m/%Y")),
    water.start = as.POSIXct(water.start, format = "%H:%M") %>% format(format = "%H:%M"),
    water.end = as.POSIXct(water.end, format = "%H:%M") %>% format(format = "%H:%M")
  ) %>%
  dplyr::select(1:5) %>%
  dplyr::rename("animal_id" = 1, "exp_id" = 2) %>%
  dplyr::mutate(exp_id = tolower(exp_id))
water
```


```{r, message=F}
mass <- read.csv(file.path("Mass Log.csv"), na.strings = c("", "NA")) %>%
  as_tibble() %>%
  dplyr::select(-X, -X.1) %>%
  na.omit() %>%
  unite(col = "dm", date, mass, sep = "_") %>%
  unite(col = "dm1", date.1, mass.1, sep = "_") %>%
  unite(col = "dm2", date.2, mass.2, sep = "_") %>%
  unite(col = "dm3", date.3, mass.3, sep = "_") %>%
  unite(col = "dm4", date.4, mass.4, sep = "_") %>%
  unite(col = "dm5", date.5, mass.5, sep = "_") %>%
  unite(col = "dm6", date.6, mass.6, sep = "_") %>%
  unite(col = "dm7", date.7, mass.7, sep = "_") %>%
  unite(col = "dm8", date.8, mass.8, sep = "_") %>%
  unite(col = "dm9", date.9, mass.9, sep = "_") %>%
  unite(col = "dm10", date.10, mass.10, sep = "_") %>%
  gather(
    key = "dm_cols", value = "dm_values",
    dm, dm1, dm2, dm3, dm4, dm5, dm6, dm7, dm8, dm9, dm10
  ) %>%
  tidyr::extract(
    col = dm_values,
    into = c("date", "mass"),
    regex = "([[:alnum:][:punct:] ]+)_([[:alnum:]]+)"
  ) %>%
  dplyr::rename("animal_id" = 1, "exp_id" = 2) %>%
  dplyr::select(-dm_cols) %>%
  dplyr::mutate(date = as.Date(date, tryFormats = c("%d/%m/%Y"))) %>%
  dplyr::mutate(exp_id = tolower(exp_id))

mass
```


```{r message=F}
time_ranges <- left_join(water, sessions) %>%
  unite(col = "water_se", water.start, water.end, sep = "_") %>%
  unite(col = "training_se", starttime, endtime, sep = "_") %>%
  gather(key = "proc_type", "proc_time_range", water_se, training_se) %>%
  tidyr::extract(
    col = proc_time_range,
    into = c("start", "end"),
    regex = "([[:alnum:][:punct:] ]+)_([[:alnum:][:punct:]]+)"
  )

time_ranges
```


```{r message=F}
time_ranges <- left_join(water, sessions) %>%
  dplyr::filter(animal_id != "") %>%
  dplyr::arrange(animal_id) %>%
  dplyr::rename(
    "Animal" = animal_id,
    "Experimenter" = exp_id,
    "Date" = date,
    "Training ON" = starttime,
    "Training OFF" = endtime,
    "Water ON" = water.start,
    "Water OFF" = water.end
  ) %>%
  dplyr::mutate(
    Training = difftime(
      `Training OFF` %>% as.POSIXct(format = "%H:%M"),
      `Training ON` %>% as.POSIXct(format = "%H:%M"),
      units = "min"
    ) %>% as.numeric() %>% replace_na(""),
    Watering = difftime(
      `Water OFF` %>% as.POSIXct(format = "%H:%M"),
      `Water ON` %>% as.POSIXct(format = "%H:%M"),
      units = "min"
    ) %>% as.numeric() %>% replace_na("")
  ) %>%
  dplyr::relocate(`Training ON`, .before = `Training OFF`)

unit.scale <- function(x) (x - min(x)) / (max(x) - min(x))
unit.scale2 <- function(x) (x /100)
unit.scale3 <- function(x) (1 / x)
unit.scale4 <- function(x) (x - mean(x) / sd(x))

time_ranges %>%
  dplyr::filter(Experimenter == "athena") %>%
  formattable::formattable(
    align = c("c", "c", "r", "c", "c", "c", "c", "l", "l"),
    list(
      `Watering` = color_bar(color = "#AAD6E6", fun = unit.scale2),
      `Training` = color_bar(color = "pink", fun = unit.scale2)
      # `Training` = color_tile("pink", "red")
    )
  )
```



```{r}
time_ranges %>%
  dplyr::filter(date == "2019-10-14") %>%
  dplyr::mutate(
    start = as.POSIXct(start, format = "%H:%M"),
    end = as.POSIXct(end, format = "%H:%M")
  ) %>%
  ggplot(mapping = aes(x = start, y = animal_id)) +
  geom_linerange(aes(xmin = start, xmax = end, col = proc_type), size = 2) +
  scale_x_datetime(breaks = "15 min", labels = scales::date_format("%H:%M"))
# geom_text_repel(
#   data = time_ranges %>%
#     dplyr::filter(date == "2019-10-14") %>%
#     dplyr::mutate(
#       start = as.POSIXct(start, format = "%H:%M") %>% format(format = "%H:%M"),
#       end = as.POSIXct(end, format = "%H:%M") %>% format(format = "%H:%M")) %>%
#     dplyr::filter(proc_type == "water_se"),
#   mapping = aes(label = paste0("Watering time: ", end-start, " min")),
#   hjust = -0.9,
#   direction = "y")
```


```{r, warning=F}

mass_formatter <-
  formatter("span",
    style = x ~ style(
      font.weight = "bold",
      color = ifelse(
        test = c(NA, diff(as.numeric(x))) > 0, ### NA to shift it by 1 to get the correct colors
        yes = "green",
        no = ifelse(c(NA, diff(as.numeric(x))) < 0, "red", "black")
      )
    ),
    x ~ icontext(ifelse(
      test = c(NA, diff(as.numeric(x))) > 0,
      yes = "arrow-up",
      no = ifelse(c(NA, diff(as.numeric(x))) < 0, "arrow-down", "minus")
    ), x)
  )



mass %>%
  dplyr::filter(animal_id == "VP01") %>%
  dplyr::rename("Animal" = animal_id, "Experimenter" = exp_id, "Date" = date, "Mass (g)" = mass) %>%
  # dplyr::mutate(d = c(NA, diff(as.numeric(`Mass (g)`)))) %>%
  formattable::formattable(
    align = c("c", "c", "r", "r"),
    list(
      `Mass (g)` = mass_formatter
    )
  )
```
