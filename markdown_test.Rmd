---
title: "Rat performance"
author: Viktor Plattner
output: html_notebook
---


```{r,  include=FALSE}
TRAINING <- read_csv(file.path("shiny_app", "TRAINING.csv"))
```


```{r, include=FALSE}
rigs_sessions <- matrix(data = c("AA01", "AA02", "DO01", "DO02", "SC01", "SC02","VP01", "VP02", "AA03", "AA04", "DO03", "DO04","SC03", "SC04", "VP03", "VP04", "AA05", "AA06","DO05", "DO06", "SC05", "SC06", "VP05", "VP06","AA07", "AA08", "DO07", "DO08", "VP07", "VP08"),
                        nrow = 6,
                        ncol = 5)
rownames(rigs_sessions) <- c("rig_1","rig_2","rig_3","rig_4","rig_5","rig_6")
colnames(rigs_sessions) <- c("session_1","session_2","session_3","session_4","session_5")
```



```{r, include=FALSE}
TRAINING <- TRAINING %>%
  mutate(date = date %>% as.Date(format = c("%d-%b-%Y"))) %>%
  mutate(animal_id = animal_id %>% toupper()) %>%
  dplyr::filter(animal_id != "RATNAME", animal_id != "SOUNDRAT", animal_id != "TEST01") %>%
  mutate(session_length = difftime(save_time, start_time, units = "mins")) %>% 
  mutate(settings_file = ifelse(settings_file == "empty_field_in_mat_file", 
                                yes = "empty_field_in_mat_file",
                                no = settings_file %>% substr(start = nchar(.) - 10, stop = nchar(.) - 4)
                                )
         ) %>% 
  mutate(protocol = file %>% substr(
                           start = file %>% gregexpr(pattern = "@") %>% unlist(),
                           stop =  file %>% 
                             gregexpr(pattern = "_") %>% 
                             map(~ .x[[2]]) %>% 
  #https://community.rstudio.com/t/extract-single-list-element-as-part-of-a-pipeline/1095/5
                             unlist() %>%  `-` (1))
         ) %>% 
  mutate(stage = replace(stage, stage == 0, "0_side_poke_on")) %>%
  mutate(stage = replace(stage, stage == 1, "1_center_poke_on")) %>%
  mutate(stage = replace(stage, 
                         A2_time > 0 & A2_time < 0.5 & reward_type == "Always", 
                         "2_intord_stim")) %>%
  mutate(stage = replace(stage, reward_type == "NoReward", "3_NoReward")) %>% 
  rowwise() %>% 
  mutate(rig = which(rigs_sessions == animal_id, arr.ind = T)[1] ) %>% 
  mutate(session = which(rigs_sessions == animal_id, arr.ind = T)[2]) %>% 
  ungroup() %>% 
  gather(right_trials, left_trials, key = "choice_direction", value = "No_pokes")
```



### Plotting session lengths

```{r}
ggplot(data = TRAINING %>% 
         dplyr::filter(session_length > 0) %>% 
         select(session_length),
       mapping = aes(x = session_length)) + 
  geom_histogram(bins = 70) + 
  scale_x_continuous(breaks = seq(from = 0, to = 300, by = 25), minor_breaks = F)

```


### Session length over time


```{r, fig.width=15}

ggplot(
  data = TRAINING,
  mapping = aes(
    col = animal_id,
    x = date,
    y = (session_length * 60 * 24) %>% as.numeric()
  )
) +
  geom_line(linetype = "dashed", alpha = 0.4) +
  geom_point() +
  scale_x_date(date_breaks = "1 day", date_labels = "%b %d", minor_breaks = "1 day") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
```


```{r}
ggplot(
  data = TRAINING %>% dplyr::filter(protocol == "@SoundCategorization"),
  mapping = aes(
    x = animal_id,
    y = No_pokes
  )
) +
  geom_boxplot(aes(fill = choice_direction), alpha = 0.3) +
  geom_point(aes(group = choice_direction, col = choice_direction),
    position = position_dodge(width = 0.75),
    size = 2
  )
```



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
